// ============================================================
//  Experience Pack â€” ç»éªŒåŒ…
//  ä¸€æ¡ç»éªŒ = å‡ ä¸ª skills + å‡ æ¡ memory
//  åˆ†äº«æ—¶ skills å’Œ memory åˆ†åˆ«ç®¡ç†æƒé™
// ============================================================

/** åˆ†äº«æƒé™çº§åˆ« */
export type ShareLevel = 'public' | 'summary' | 'private';
// ğŸŸ¢ public  - å®Œæ•´åˆ†äº«
// ğŸŸ¡ summary - åªåˆ†äº«åç§°/æè¿°ï¼Œä¸åˆ†äº«å…·ä½“å†…å®¹
// ğŸ”´ private - ä¸åˆ†äº«

/** æŠ€èƒ½ï¼ˆä¸ Anthropic skills æ ¼å¼ä¸€è‡´ï¼‰*/
export interface Skill {
  name: string;           // æŠ€èƒ½åç§°ï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
  description: string;    // ç®€çŸ­æè¿°
  instructions: string;   // æ‰§è¡ŒæŒ‡ä»¤ (markdown)
  shareLevel: ShareLevel; // åˆ†äº«æƒé™ï¼Œé»˜è®¤ 'public'
  lastModified?: number;  // æœ€åä¿®æ”¹æ—¶é—´æˆ³ï¼ˆåŒæ­¥ç”¨ï¼‰
  deletedAt?: number;     // åˆ é™¤æ—¶é—´æˆ³ï¼ˆtombstoneï¼Œ0 = æœªåˆ é™¤ï¼‰
}

/** è®°å¿† */
export interface Memory {
  key: string;            // å¦‚ "é¡¹ç›®è·¯å¾„" / "å½“å‰ç‰ˆæœ¬"ï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
  value: string;          // å…·ä½“å€¼
  shareLevel: ShareLevel; // åˆ†äº«æƒé™ï¼Œé»˜è®¤ 'private'
  lastModified?: number;  // æœ€åä¿®æ”¹æ—¶é—´æˆ³ï¼ˆåŒæ­¥ç”¨ï¼‰
  deletedAt?: number;     // åˆ é™¤æ—¶é—´æˆ³ï¼ˆtombstoneï¼Œ0 = æœªåˆ é™¤ï¼‰
}

/** ä¸€æ¡ç»éªŒ = skills + memory */
export interface Experience {
  id: string;
  name: string;           // ç»éªŒåç§°ï¼Œå¦‚ "ClawdBotHarmony å¼€å‘"
  description: string;    // ç®€è¿°
  skills: Skill[];        // ç›¸å…³æŠ€èƒ½
  memory: Memory[];       // ç›¸å…³è®°å¿†
  createdAt: number;
  updatedAt: number;
}

/** ç»éªŒåŒ… */
export interface ExperiencePack {
  version: number;        // schema ç‰ˆæœ¬
  updatedAt: number;      // æœ€åæ›´æ–°æ—¶é—´
  syncedAt: number;       // æœ€ååŒæ­¥æ—¶é—´ (0 = æœªåŒæ­¥)
  experiences: Experience[];
}

/** ç”Ÿæˆå”¯ä¸€ ID */
export function generateId(): string {
  return Date.now().toString(36) + Math.random().toString(36).substring(2, 8);
}

/** åˆ›å»ºç©ºçš„ç»éªŒåŒ… */
export function createDefaultExperiencePack(): ExperiencePack {
  return {
    version: 3,
    updatedAt: Date.now(),
    syncedAt: 0,
    experiences: [],
  };
}

/** åˆ›å»ºæ–°ç»éªŒ */
export function createExperience(name: string, description: string): Experience {
  return {
    id: generateId(),
    name,
    description,
    skills: [],
    memory: [],
    createdAt: Date.now(),
    updatedAt: Date.now(),
  };
}

/** åˆ›å»ºæ–°æŠ€èƒ½ (é»˜è®¤å…¬å¼€åˆ†äº«) */
export function createSkill(name: string, description: string, instructions: string): Skill {
  return {
    name,
    description,
    instructions,
    shareLevel: 'public',
    lastModified: Date.now(),
    deletedAt: 0,
  };
}

/** åˆ›å»ºæ–°è®°å¿† (é»˜è®¤ç§å¯†) */
export function createMemory(key: string, value: string): Memory {
  return {
    key,
    value,
    shareLevel: 'private',
    lastModified: Date.now(),
    deletedAt: 0,
  };
}

/** è·å–æœªåˆ é™¤çš„æŠ€èƒ½ */
export function getActiveSkills(exp: Experience): Skill[] {
  return exp.skills.filter((s: Skill) => !s.deletedAt || s.deletedAt === 0);
}

/** è·å–æœªåˆ é™¤çš„è®°å¿† */
export function getActiveMemories(exp: Experience): Memory[] {
  return exp.memory.filter((m: Memory) => !m.deletedAt || m.deletedAt === 0);
}

/** è·å–åˆ†äº«çº§åˆ«å›¾æ ‡ */
export function getShareLevelIcon(level: ShareLevel): string {
  switch (level) {
    case 'public': return 'ğŸŸ¢';
    case 'summary': return 'ğŸŸ¡';
    case 'private': return 'ğŸ”´';
    default: return 'âšª';
  }
}

/** è·å–åˆ†äº«çº§åˆ«æ–‡å­— */
export function getShareLevelText(level: ShareLevel): string {
  switch (level) {
    case 'public': return 'å…¬å¼€';
    case 'summary': return 'æ‘˜è¦';
    case 'private': return 'ç§å¯†';
    default: return 'æœªçŸ¥';
  }
}
