/**
 * GeofenceSuggestionCard â€” å›´æ å»ºè®®å¡ç‰‡
 *
 * å½“ LocationDiscoveryService å‘çŽ°ç”¨æˆ·ç»å¸¸åŽ»æŸä¸ªä½ç½®æ—¶ï¼Œ
 * æ˜¾ç¤ºæ­¤å¡ç‰‡å»ºè®®æ·»åŠ å›´æ ã€‚
 *
 * æ“ä½œï¼š
 *   - "æ·»åŠ å›´æ " â†’ å±•å¼€ç¼–è¾‘åŒºåŸŸï¼ˆå¯ä¿®æ”¹åç§°/ç±»åˆ«ï¼‰â†’ ç¡®è®¤æ·»åŠ 
 *   - "å¿½ç•¥" â†’ æ°¸ä¸å†å»ºè®®æ­¤ä½ç½®
 *   - "ä»¥åŽå†è¯´" â†’ 7 å¤©åŽå¯èƒ½å†æ¬¡å»ºè®®
 */

@Component
export struct GeofenceSuggestionCard {
  /** å»ºè®®æ•°æ® */
  @Prop suggestionId: string = '';
  @Prop name: string = '';
  @Prop category: string = '';
  @Prop reason: string = '';
  @Prop confidence: number = 0;
  @Prop latitude: number = 0;
  @Prop longitude: number = 0;
  @Prop radiusMeters: number = 0;

  /** å›žè°ƒ */
  onAccept: (id: string, name: string, category: string) => void = () => {};
  onIgnore: (id: string) => void = () => {};
  onDefer: (id: string) => void = () => {};

  /** å†…éƒ¨çŠ¶æ€ */
  @State editing: boolean = false;
  @State editName: string = '';
  @State selectedCatIndex: number = 5;
  @State dismissed: boolean = false;

  private catIds: string[] = ['home', 'work', 'gym', 'restaurant', 'shopping', 'custom'];
  private catLabels: string[] = ['ðŸ  å®¶', 'ðŸ¢ å…¬å¸', 'ðŸ’ª å¥èº«æˆ¿', 'ðŸœ é¤åŽ…', 'ðŸ›’ è´­ç‰©', 'ðŸ“ å…¶ä»–'];

  aboutToAppear(): void {
    this.editName = this.name;
    let idx = this.catIds.indexOf(this.category);
    this.selectedCatIndex = idx >= 0 ? idx : 5;
  }

  build() {
    Column() {
      // Header
      Row() {
        Text('ðŸ“')
          .fontSize(16)
        Text('å‘çŽ°ä½ ç»å¸¸åŽ»è¿™é‡Œ')
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#007AFF')
          .margin({ left: 6 })
        Blank()
        if (this.confidence > 0) {
          Text(Math.round(this.confidence * 100).toString() + '% ç½®ä¿¡')
            .fontSize(11)
            .fontColor('#999999')
        }
      }
      .width('100%')

      // å»ºè®®ä¿¡æ¯
      Row() {
        Text(this.getCatIcon())
          .fontSize(28)
          .margin({ right: 12 })
        Column({ space: 4 }) {
          Text(this.name)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1A1A1A')
          Text(this.reason)
            .fontSize(13)
            .fontColor('#666666')
            .maxLines(2)
          Text(this.latitude.toFixed(4) + ', ' + this.longitude.toFixed(4) +
            '  r=' + this.radiusMeters.toString() + 'm')
            .fontSize(11)
            .fontColor('#BBBBBB')
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')
      .margin({ top: 12 })

      if (this.editing) {
        // ç¼–è¾‘æ¨¡å¼
        Column({ space: 10 }) {
          Divider().color('#F0F0F0').margin({ top: 12 })

          TextInput({ text: this.editName, placeholder: 'å›´æ åç§°' })
            .onChange((val: string) => { this.editName = val; })
            .width('100%')
            .height(40)

          Text('é€‰æ‹©ç±»åˆ«')
            .fontSize(13)
            .fontColor('#666666')
            .width('100%')

          Flex({ wrap: FlexWrap.Wrap }) {
            ForEach(this.catLabels, (label: string) => {
              Text(label)
                .fontSize(12)
                .fontColor(this.selectedCatIndex === this.catLabels.indexOf(label) ? Color.White : '#1A1A1A')
                .backgroundColor(this.selectedCatIndex === this.catLabels.indexOf(label) ? '#007AFF' : '#F0F0F0')
                .padding({ left: 10, right: 10, top: 5, bottom: 5 })
                .borderRadius(14)
                .margin(3)
                .onClick(() => { this.selectedCatIndex = this.catLabels.indexOf(label); })
            }, (label: string) => label)
          }
          .width('100%')

          Row({ space: 12 }) {
            Button('å–æ¶ˆ')
              .fontSize(13)
              .backgroundColor('#F0F0F0')
              .fontColor('#666666')
              .layoutWeight(1)
              .height(36)
              .onClick(() => { this.editing = false; })
            Button('ç¡®è®¤æ·»åŠ ')
              .fontSize(13)
              .backgroundColor('#007AFF')
              .fontColor(Color.White)
              .layoutWeight(1)
              .height(36)
              .onClick(() => { this.confirmAdd(); })
          }
          .width('100%')
          .margin({ top: 4 })
        }
      } else {
        // æ“ä½œæŒ‰é’®
        Row({ space: 10 }) {
          Button('æ·»åŠ å›´æ ')
            .fontSize(13)
            .backgroundColor('#007AFF')
            .fontColor(Color.White)
            .layoutWeight(1)
            .height(36)
            .onClick(() => { this.editing = true; })
          Button('å¿½ç•¥')
            .fontSize(13)
            .backgroundColor('#F0F0F0')
            .fontColor('#FF3B30')
            .layoutWeight(1)
            .height(36)
            .onClick(() => {
              this.onIgnore(this.suggestionId);
              this.dismissed = true;
            })
          Button('ä»¥åŽå†è¯´')
            .fontSize(13)
            .backgroundColor('#F0F0F0')
            .fontColor('#666666')
            .layoutWeight(1)
            .height(36)
            .onClick(() => {
              this.onDefer(this.suggestionId);
              this.dismissed = true;
            })
        }
        .width('100%')
        .margin({ top: 14 })
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({ radius: 4, color: '#0000000D', offsetX: 0, offsetY: 2 })
    .visibility(this.dismissed ? Visibility.None : Visibility.Visible)
  }

  private getCatIcon(): string {
    if (this.category === 'home') return 'ðŸ ';
    if (this.category === 'work') return 'ðŸ¢';
    if (this.category === 'gym') return 'ðŸ’ª';
    if (this.category === 'restaurant') return 'ðŸœ';
    if (this.category === 'shopping') return 'ðŸ›’';
    return 'ðŸ“';
  }

  private confirmAdd(): void {
    let finalName = this.editName.length > 0 ? this.editName : this.name;
    let finalCategory = this.catIds[this.selectedCatIndex];
    this.onAccept(this.suggestionId, finalName, finalCategory);
    this.dismissed = true;
  }
}
